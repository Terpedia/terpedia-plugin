name: Sync Terpedia Plugin to terpedia.com

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  sync-to-production:
    runs-on: ubuntu-latest
    env:
      WEBHOOK_URL: ${{ secrets.WP_DEPLOY_WEBHOOK_URL }}
      WEBHOOK_SECRET: ${{ secrets.WP_DEPLOY_WEBHOOK_SECRET }}
    
    steps:
    - name: Checkout terpedia-plugin
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
    - name: Trigger WordPress deployer webhook
      if: env.WEBHOOK_URL != ''
      run: |
        echo "üöÄ Triggering WordPress deployer webhook..."
        set -euo pipefail
        STATUS=$(curl -sS -w "%{http_code}" -o /tmp/deploy_response.txt \
          -X POST "$WEBHOOK_URL" \
          -H "Content-Type: application/json" \
          -H "X-Deploy-Token: $WEBHOOK_SECRET" \
          -d '{
            "repository": "${{ github.repository }}",
            "ref": "${{ github.ref_name }}",
            "sha": "${{ github.sha }}",
            "event": "ci_deploy",
            "source": "github_actions"
          }')
        echo "üîé Webhook HTTP status: $STATUS"
        echo "---- Response Body ----"
        cat /tmp/deploy_response.txt | sed -e 's/.*/&/'
        echo "------------------------"
        if [ "$STATUS" -lt 200 ] || [ "$STATUS" -ge 300 ]; then
          echo "‚ùå Webhook call failed"
          exit 1
        fi
        echo "‚úÖ Webhook triggered successfully"

    - name: Skip deploy (no webhook configured)
      if: env.WEBHOOK_URL == ''
      run: |
        echo "‚ÑπÔ∏è No WP deployer webhook configured (WP_DEPLOY_WEBHOOK_URL). Skipping deploy."
    
    - name: Notify success
      if: success()
      run: |
        echo "üéâ Terpedia Plugin deployment completed!"
        echo "üìÖ Sync completed at: $(date)"
        echo "üîó Plugin URL: https://terpedia.com/wp-content/plugins/terpedia-plugin/"
    
    - name: Notify failure
      if: failure()
      run: |
        echo "‚ùå Failed to deploy Terpedia Plugin via webhook"
        echo "üìÖ Failure occurred at: $(date)"
        echo "Please check the logs and try again."
