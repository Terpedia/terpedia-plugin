name: Sync Terpedia Plugin to terpedia.com

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  sync-to-production:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout terpedia-plugin
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.TERPEDIA_SSH_PRIVATE_KEY }}
    
    - name: Add SSH known hosts
      run: |
        ssh-keyscan -H -p 18765 giow1015.siteground.us >> ~/.ssh/known_hosts
    
    - name: Sync plugin to terpedia.com
      run: |
        echo "ğŸš€ Syncing Terpedia Plugin to terpedia.com..."
        
        # Create temporary directory
        mkdir -p /tmp/terpedia-plugin-sync
        
        # Copy all plugin files
        rsync -av --delete \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='*.md' \
          --exclude='issues/' \
          --exclude='specifications.csv' \
          --exclude='terpedia-replit-bridge.php' \
          --exclude='terpedia.php.bak' \
          ./ /tmp/terpedia-plugin-sync/
        
        # Sync to production server
        rsync -av --delete \
          -e "ssh -p 18765 -o StrictHostKeyChecking=no -o IdentitiesOnly=yes -o PasswordAuthentication=no" \
          /tmp/terpedia-plugin-sync/ \
          giow1015@giow1015.siteground.us:./www/terpedia.com/public_html/wp-content/plugins/terpedia-plugin/
        
        echo "âœ… Plugin sync completed successfully!"
    
    - name: Verify sync
      run: |
        echo "ğŸ” Verifying plugin files on production server..."
        
        # Check if main plugin file exists
        ssh -p 18765 -o StrictHostKeyChecking=no -o IdentitiesOnly=yes giow1015@giow1015.siteground.us \
          "test -f ./www/terpedia.com/public_html/wp-content/plugins/terpedia-plugin/terpedia.php && echo 'âœ… Main plugin file exists' || echo 'âŒ Main plugin file missing'"
        
        # Check if dashboard widget exists
        ssh -p 18765 -o StrictHostKeyChecking=no -o IdentitiesOnly=yes giow1015@giow1015.siteground.us \
          "test -f ./www/terpedia.com/public_html/wp-content/plugins/terpedia-plugin/includes/terpedia-dashboard-widget.php && echo 'âœ… Dashboard widget exists' || echo 'âŒ Dashboard widget missing'"
        
        # Check plugin version
        ssh -p 18765 -o StrictHostKeyChecking=no -o IdentitiesOnly=yes giow1015@giow1015.siteground.us \
          "grep 'Version:' ./www/terpedia.com/public_html/wp-content/plugins/terpedia-plugin/terpedia.php | head -1"
        
        echo "ğŸ‰ Verification completed!"
    
    - name: Notify success
      if: success()
      run: |
        echo "ğŸ‰ Terpedia Plugin successfully synced to terpedia.com!"
        echo "ğŸ“… Sync completed at: $(date)"
        echo "ğŸ”— Plugin URL: https://terpedia.com/wp-content/plugins/terpedia-plugin/"
    
    - name: Notify failure
      if: failure()
      run: |
        echo "âŒ Failed to sync Terpedia Plugin to terpedia.com"
        echo "ğŸ“… Failure occurred at: $(date)"
        echo "Please check the logs and try again."
