name: Deploy Terpedia Plugin to Production

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP for version management
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        
    - name: Bump version automatically
      run: |
        echo "Current version: $(php version-manager.php current)"
        new_version=$(php version-manager.php increment patch)
        echo "New version: $new_version"
        
    - name: Commit version bump
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add terpedia.php VERSION
        git commit -m "Bump plugin version to $(php version-manager.php current)" || exit 0
        git push origin main
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Setup SSH Agent
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: Add SSH known hosts
      run: |
        ssh-keyscan -p 18765 giow1015.siteground.us >> ~/.ssh/known_hosts
        
    - name: Deploy plugin to production
      run: |
        # Create clean deployment directory
        mkdir -p deploy-temp
        
        # Copy only needed files (exclude git, github, node_modules)
        rsync -av --exclude='.git*' --exclude='.github*' --exclude='node_modules' --exclude='*.log' --exclude='*.tmp' --exclude='deploy-temp' . deploy-temp/
        
        # Create deployment package from clean directory
        tar -czf terpedia-plugin.tar.gz -C deploy-temp .
        
        # Upload to server using SSH agent
        rsync -az --delete -e "ssh -p 18765" deploy-temp/ ${{ secrets.SSH_USER }}@giow1015.siteground.us:www/terpedia.com/public_html/wp-content/plugins/terpedia-plugin/
        
        # Set proper permissions and activate via SSH
        ssh -p 18765 ${{ secrets.SSH_USER }}@giow1015.siteground.us << 'EOF'
          # Navigate to plugin directory
          cd www/terpedia.com/public_html/wp-content/plugins/terpedia-plugin
          
          # Set proper permissions
          find . -type f -exec chmod 644 {} \;
          find . -type d -exec chmod 755 {} \;
          
          # Activate plugin and clear cache if WP-CLI is available
          if command -v wp &> /dev/null; then
            wp plugin activate terpedia-plugin --path=~/www/terpedia.com/public_html/ --allow-root
            wp cache flush --path=~/www/terpedia.com/public_html/ --allow-root
            wp rewrite flush --path=~/www/terpedia.com/public_html/ --allow-root
          fi
          
          echo "üöÄ Plugin deployment completed successfully at $(date)"
        EOF
        
    - name: Verify deployment
      run: |
        ssh -p 18765 ${{ secrets.SSH_USER }}@giow1015.siteground.us << 'EOF'
          # Check if plugin files exist
          if [ -f "www/terpedia.com/public_html/wp-content/plugins/terpedia-plugin/terpedia.php" ]; then
            echo "‚úÖ Plugin files deployed successfully"
            # Extract version from main plugin file
            version=$(grep "Version:" "www/terpedia.com/public_html/wp-content/plugins/terpedia-plugin/terpedia.php" | head -1 | cut -d' ' -f3)
            echo "üì¶ Plugin version: $version"
          else
            echo "‚ùå Plugin deployment failed"
            exit 1
          fi
          
          # Check WordPress plugin status if WP-CLI is available
          if command -v wp &> /dev/null; then
            plugin_status=$(wp plugin status terpedia-plugin --path=~/www/terpedia.com/public_html/ --allow-root)
            echo "üîå Plugin status: $plugin_status"
            
            # Check if custom post types are registered
            post_types=$(wp post-type list --field=name --path=~/www/terpedia.com/public_html/ --allow-root | grep -E "(terpene|podcast|research)" || echo "No custom post types found")
            echo "üìã Custom post types: $post_types"
          fi
        EOF

    - name: Run plugin health checks
      run: |
        ssh -p 18765 ${{ secrets.SSH_USER }}@giow1015.siteground.us << 'EOF'
          if command -v wp &> /dev/null; then
            # Check for PHP errors
            echo "üîç Checking for PHP errors..."
            wp eval 'if (function_exists("terpedia_encyclopedia_shortcode")) { echo "‚úÖ Plugin functions loaded\n"; } else { echo "‚ùå Plugin functions not loaded\n"; }' --path=~/www/terpedia.com/public_html/ --allow-root
            
            # Verify database tables exist (if plugin creates custom tables)
            echo "üóÑÔ∏è Checking database integration..."
            wp eval 'global $wpdb; $tables = $wpdb->get_results("SHOW TABLES LIKE \"%terpedia%\""); echo count($tables) > 0 ? "‚úÖ Database tables present\n" : "‚ÑπÔ∏è No custom tables found\n";' --path=~/www/terpedia.com/public_html/ --allow-root
            
            # Test shortcode functionality
            echo "üìù Testing shortcode functionality..."
            wp eval 'echo do_shortcode("[terpedia_encyclopedia]") ? "‚úÖ Shortcodes working\n" : "‚ùå Shortcode issues\n";' --path=~/www/terpedia.com/public_html/ --allow-root
          fi
        EOF

    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "üöÄ Terpedia plugin deployed successfully to production"
        else
          echo "‚ùå Plugin deployment failed"
        fi