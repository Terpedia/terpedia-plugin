name: Deploy Terpedia Plugin to Production

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP for version management
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        
    - name: Bump version automatically
      run: |
        echo "Current version: $(php version-manager.php current)"
        new_version=$(php version-manager.php increment patch)
        echo "New version: $new_version"
        
    - name: Commit version bump
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add terpedia.php VERSION
        git commit -m "Bump plugin version to $(php version-manager.php current)" || exit 0
        git push origin main
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Setup SSH Agent
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: Setup SSH configuration
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # Add SSH known hosts with proper error handling
        ssh-keyscan -p 18765 -t rsa,ed25519 giow1015.siteground.us >> ~/.ssh/known_hosts 2>/dev/null || true
        ssh-keyscan -p 18765 giow1015.siteground.us >> ~/.ssh/known_hosts 2>/dev/null || true
        chmod 600 ~/.ssh/known_hosts
        
        # Configure SSH client
        cat >> ~/.ssh/config << 'EOF'
        Host giow1015.siteground.us
          HostName giow1015.siteground.us
          Port 18765
          User ${{ secrets.SSH_USER }}
          StrictHostKeyChecking no
          UserKnownHostsFile ~/.ssh/known_hosts
          IdentitiesOnly yes
          ServerAliveInterval 30
          ServerAliveCountMax 3
        EOF
        chmod 600 ~/.ssh/config
        
    - name: Test SSH Connection
      run: |
        echo "Testing SSH connection..."
        ssh -o ConnectTimeout=10 ${{ secrets.SSH_USER }}@giow1015.siteground.us "echo 'SSH connection successful' && pwd && ls -la www/terpedia.com/public_html/wp-content/plugins/ | head -5"
        
    - name: Deploy plugin to production
      run: |
        # Create clean deployment directory
        mkdir -p deploy-temp
        
        # Copy only needed files (exclude git, github, node_modules)
        rsync -av --exclude='.git*' --exclude='.github*' --exclude='node_modules' --exclude='*.log' --exclude='*.tmp' --exclude='deploy-temp' . deploy-temp/
        
        # Create deployment package from clean directory
        tar -czf terpedia-plugin.tar.gz -C deploy-temp .
        
        # Upload to server using SSH agent with enhanced options
        echo "Starting deployment to production server..."
        rsync -avz --delete --timeout=300 --progress \
          -e "ssh -o ConnectTimeout=30 -o ServerAliveInterval=30" \
          deploy-temp/ ${{ secrets.SSH_USER }}@giow1015.siteground.us:www/terpedia.com/public_html/wp-content/plugins/terpedia-plugin/
        
        echo "Upload completed. Setting permissions and activating plugin..."
        
        # Set proper permissions and activate via SSH with timeout
        ssh -o ConnectTimeout=30 -o ServerAliveInterval=30 ${{ secrets.SSH_USER }}@giow1015.siteground.us << 'EOF'
          # Navigate to plugin directory
          cd www/terpedia.com/public_html/wp-content/plugins/terpedia-plugin
          
          # Set proper permissions
          find . -type f -exec chmod 644 {} \;
          find . -type d -exec chmod 755 {} \;
          
          # Activate plugin and clear cache if WP-CLI is available
          if command -v wp &> /dev/null; then
            wp plugin activate terpedia-plugin --path=~/www/terpedia.com/public_html/ --allow-root
            wp cache flush --path=~/www/terpedia.com/public_html/ --allow-root
            wp rewrite flush --path=~/www/terpedia.com/public_html/ --allow-root
          fi
          
          echo "ğŸš€ Plugin deployment completed successfully at $(date)"
        EOF
        
    - name: Verify deployment
      run: |
        echo "Verifying deployment..."
        ssh -o ConnectTimeout=30 ${{ secrets.SSH_USER }}@giow1015.siteground.us << 'EOF'
          # Check if plugin files exist
          if [ -f "www/terpedia.com/public_html/wp-content/plugins/terpedia-plugin/terpedia.php" ]; then
            echo "âœ… Plugin files deployed successfully"
            # Extract version from main plugin file
            version=$(grep "Version:" "www/terpedia.com/public_html/wp-content/plugins/terpedia-plugin/terpedia.php" | head -1 | cut -d' ' -f3)
            echo "ğŸ“¦ Plugin version: $version"
          else
            echo "âŒ Plugin deployment failed"
            exit 1
          fi
          
          # Check WordPress plugin status if WP-CLI is available
          if command -v wp &> /dev/null; then
            plugin_status=$(wp plugin status terpedia-plugin --path=~/www/terpedia.com/public_html/ --allow-root)
            echo "ğŸ”Œ Plugin status: $plugin_status"
            
            # Check if custom post types are registered
            post_types=$(wp post-type list --field=name --path=~/www/terpedia.com/public_html/ --allow-root | grep -E "(terpene|podcast|research)" || echo "No custom post types found")
            echo "ğŸ“‹ Custom post types: $post_types"
          fi
        EOF

    - name: Run plugin health checks
      run: |
        echo "Running health checks..."
        ssh -o ConnectTimeout=30 ${{ secrets.SSH_USER }}@giow1015.siteground.us << 'EOF'
          if command -v wp &> /dev/null; then
            # Check for PHP errors
            echo "ğŸ” Checking for PHP errors..."
            wp eval 'if (function_exists("terpedia_encyclopedia_shortcode")) { echo "âœ… Plugin functions loaded\n"; } else { echo "âŒ Plugin functions not loaded\n"; }' --path=~/www/terpedia.com/public_html/ --allow-root
            
            # Verify database tables exist (if plugin creates custom tables)
            echo "ğŸ—„ï¸ Checking database integration..."
            wp eval 'global $wpdb; $tables = $wpdb->get_results("SHOW TABLES LIKE \"%terpedia%\""); echo count($tables) > 0 ? "âœ… Database tables present\n" : "â„¹ï¸ No custom tables found\n";' --path=~/www/terpedia.com/public_html/ --allow-root
            
            # Test shortcode functionality
            echo "ğŸ“ Testing shortcode functionality..."
            wp eval 'echo do_shortcode("[terpedia_encyclopedia]") ? "âœ… Shortcodes working\n" : "âŒ Shortcode issues\n";' --path=~/www/terpedia.com/public_html/ --allow-root
          fi
        EOF

    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "ğŸš€ Terpedia plugin deployed successfully to production"
        else
          echo "âŒ Plugin deployment failed"
        fi